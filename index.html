<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MidwifeApp</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
:root {
    --bg-color: #f9f9f9;
    --text-color: #333;
    --item-bg: #fff;
    --item-border: #ddd;
    --item-overdue-bg: #ffecec;
    --item-overdue-border: #ff0000;
    --item-done-bg: #e6f4ea;
    --item-done-border: #28a745;
    --button-bg: #007bff;
    --button-hover-bg: #0056b3;
}
body.dark {
    --bg-color: #1e1e1e;
    --text-color: #eee;
    --item-bg: #2c2c2c;
    --item-border: #444;
    --item-overdue-bg: #5a1e1e;
    --item-overdue-border: #ff6666;
    --item-done-bg: #1e452e;
    --item-done-border: #28a745;
    --button-bg: #28a745;
    --button-hover-bg: #1c6e2a;
}

body {
    font-family: Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: background-color 0.3s, color 0.3s;
}

h1 { text-align: center; color: var(--text-color); }

.item {
    background-color: var(--item-bg);
    border: 1px solid var(--item-border);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    width: 100%;
    max-width: 400px;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}

.item.overdue { border-color: var(--item-overdue-border); background-color: var(--item-overdue-bg); }
.item.done { border-color: var(--item-done-border); background-color: var(--item-done-bg); }

.icon {
    font-size: 24px;
    margin-right: 15px;
    color: var(--text-color);
}

.content { flex: 1; }

.title {
    font-size: 18px;
    font-weight: bold;
    margin: 0;
    color: var(--text-color);
}

.description, .last-time {
    font-size: 14px;
    color: var(--text-color);
    margin: 5px 0;
}

button {
    background-color: var(--button-bg);
    color: var(--text-color);
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
}

button:hover { background-color: var(--button-hover-bg); }

#error-message { color: red; text-align: center; margin-top: 10px; }

/* Toggle –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
#notifications-control, #theme-control {
    width: 100%;
    max-width: 400px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    margin-bottom: 20px;
}

#notifications-control .toggle-label, #theme-control .toggle-label {
    font-size: 14px;
    color: var(--text-color);
    user-select: none;
}

.toggle {
    position: relative;
    width: 44px;
    height: 24px;
}

.toggle input { display: none; }

.toggle .slider {
    position: absolute;
    inset: 0;
    background: #ccc;
    border-radius: 24px;
    transition: .2s;
}

.toggle .slider::after {
    content: "";
    position: absolute;
    width: 18px; height: 18px;
    left: 3px; top: 3px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    transition: .2s;
}

.toggle input:checked + .slider { background: #28a745; }
.toggle input:checked + .slider::after { transform: translateX(20px); }

/* –°—Å—ã–ª–∫–∞ –Ω–∞ events.html */
#events-link {
    display: block;
    margin-bottom: 20px;
    text-decoration: none;
    color: var(--text-color);
    font-weight: bold;
}

#events-link:hover { text-decoration: underline; }

</style>
</head>
<body>

<div id="theme-control" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã">
    <span class="toggle-label">–ù–æ—á–Ω–∞—è —Ç–µ–º–∞</span>
    <label class="toggle">
        <input type="checkbox" id="themeToggle">
        <span class="slider" aria-hidden="true"></span>
    </label>
</div>

<h1>–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ—Ä–æ–∂–¥—ë–Ω–Ω–æ–≥–æ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ —á–∞—Å—Ç–æ—Ç–∞</h1>
<a id="events-link" href="events.html">–°–ø–∏—Å–æ–∫ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</a>

<div id="error-message"></div>

<div class="item" id="feeding">
    <span class="icon">üçº</span>
    <div class="content">
        <p class="title">–ö–æ—Ä–º–ª–µ–Ω–∏–µ</p>
        <p class="description">–∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞ –¥–Ω—ë–º –∏ –Ω–æ—á—å—é</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('feeding', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="diaper">
    <span class="icon">ü©≤</span>
    <div class="content">
        <p class="title">–ü–æ–¥–≥—É–∑–Ω–∏–∫</p>
        <p class="description">–∫–∞–∂–¥—ã–µ 2-4 —á–∞—Å–∞</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('diaper', 240)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="sleep">
    <span class="icon">üåô</span>
    <div class="content">
        <p class="title">–°–æ–Ω</p>
        <p class="description">–≤ —Å—Ä–µ–¥–Ω–µ–º 14-17 —á–∞—Å–æ–≤ –≤ —Å—É—Ç–∫–∏</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('sleep', 1440)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="temperature">
    <span class="icon">üå°Ô∏è</span>
    <div class="content">
        <p class="title">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</p>
        <p class="description">–∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('temperature', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="burping">
    <span class="icon">üòä</span>
    <div class="content">
        <p class="title">–û—Ç—Ä—ã–∂–∫–∞</p>
        <p class="description">–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ—Ä–º–ª–µ–Ω–∏—è</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('burping', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="contact">
    <span class="icon">‚úã</span>
    <div class="content">
        <p class="title">–ö–æ–Ω—Ç–∞–∫—Ç</p>
        <p class="description">–∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('contact', 1440)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div id="notifications-control" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
    <span class="toggle-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
    <label class="toggle">
        <input type="checkbox" id="notificationsToggle">
        <span class="slider" aria-hidden="true"></span>
    </label>
</div>

<script type="module">
// --- Firebase ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-messaging.js";

const errorMessage = document.getElementById('error-message');

// --- Firebase config (–≤—Å—Ç–∞–≤–ª–µ–Ω–æ) ---
const firebaseConfig = {
    apiKey: "AIzaSyBUUrP-CevoeDOsUZorjC6XDzZ-vd3Uauw",
    authDomain: "ds-nurce-bdc37.firebaseapp.com",
    projectId: "ds-nurce-bdc37",
    storageBucket: "ds-nurce-bdc37.appspot.com",
    messagingSenderId: "725307523922",
    appId: "1:725307523922:web:9bb5c6ae685e479719b08b"
};

// Public VAPID Key (Web Push certificate)
const VAPID_KEY = "BEp5FjaMusKOcJPBREZEad0ZWHMMyYAp0dl_6yeFaiNdqfrtWFJ_0lA0S5kU8usP_IJu0SkdsTrSkOsRzPGYKY4";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const messaging = getMessaging(app);

// ====== –¢–µ–º–∞: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ======
const THEME_KEY = 'mw_theme';
const themeToggle = document.getElementById('themeToggle');

function applyThemeFromStorage() {
  const saved = localStorage.getItem(THEME_KEY);
  const isDark = saved === 'dark';
  document.body.classList.toggle('dark', isDark);
  themeToggle.checked = isDark;
}
applyThemeFromStorage();

themeToggle.addEventListener('change', (e) => {
  const isDark = e.target.checked;
  document.body.classList.toggle('dark', isDark);
  localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
});

// ====== –°—Ç–∞—Ç—É—Å—ã "N —á–∞—Å–æ–≤ M –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥" —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º ======
const TASKS = {
  feeding: 180,
  diaper: 240,
  sleep: 1440,
  temperature: 180,
  burping: 180,
  contact: 1440
};
const LAST_KEY = 'mw_lastTimes';
const NOTIFIED_KEY = 'mw_notified'; // —Ö—Ä–∞–Ω–∏—Ç –¥–ª—è –∫–∞–∫–æ–≥–æ last-timestamp —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

function readLastMap() {
  try { return JSON.parse(localStorage.getItem(LAST_KEY)) || {}; }
  catch { return {}; }
}
function writeLastMap(map) {
  localStorage.setItem(LAST_KEY, JSON.stringify(map));
}
function readNotifiedMap() {
  try { return JSON.parse(localStorage.getItem(NOTIFIED_KEY)) || {}; }
  catch { return {}; }
}
function writeNotifiedMap(map) {
  localStorage.setItem(NOTIFIED_KEY, JSON.stringify(map));
}

// –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä—É—Å—Å–∫–∏–µ —Ñ–æ—Ä–º—ã
function decl(n, [one, two, five]) {
  n = Math.abs(n) % 100;
  const n1 = n % 10;
  if (n > 10 && n < 20) return five;
  if (n1 > 1 && n1 < 5) return two;
  if (n1 === 1) return one;
  return five;
}

// —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è: "2 —á–∞—Å–∞ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥" –∏–ª–∏ "5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥" –∏–ª–∏ "–º–µ–Ω–µ–µ –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥"
function formatElapsed(ms) {
  const totalMin = Math.floor(ms / 60000);
  if (totalMin <= 0) return '–º–µ–Ω–µ–µ –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥';
  const hours = Math.floor(totalMin / 60);
  const mins = totalMin % 60;
  const parts = [];
  if (hours > 0) parts.push(`${hours} ${decl(hours, ['—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤'])}`);
  if (mins > 0) parts.push(`${mins} ${decl(mins, ['–º–∏–Ω—É—Ç–∞', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç'])}`);
  return parts.join(' ') + ' –Ω–∞–∑–∞–¥';
}

function setLastText(id, ts) {
  const el = document.querySelector(`#${id} .last-time`);
  if (!el) return;
  if (!ts) el.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞';
  else {
    const elapsed = Date.now() - ts;
    el.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ' + formatElapsed(elapsed);
  }
}

// ====== Overdue + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ overdue ======
let swRegistration = null;
async function ensureSWRegistration() {
  if (!('serviceWorker' in navigator)) return null;
  try {
    const existing = await navigator.serviceWorker.getRegistration();
    if (existing) { swRegistration = existing; return swRegistration; }
  } catch (e) { /* ignore */ }
  try {
    swRegistration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
    console.log('Service Worker registered for overdue-notify:', swRegistration.scope);
    return swRegistration;
  } catch (e) {
    console.warn('SW register failed (overdue notify):', e);
    try { swRegistration = await navigator.serviceWorker.getRegistration(); return swRegistration; } catch { return null; }
  }
}

const prevOverdue = {}; // –ø–æ–º–Ω–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
function refreshOverdue() {
  const map = readLastMap();
  const now = Date.now();
  const notifiedMap = readNotifiedMap();

  Object.entries(TASKS).forEach(([id, minutes]) => {
    const item = document.getElementById(id);
    if (!item) return;
    const ts = map[id];
    if (!ts) {
      item.classList.remove('overdue');
      prevOverdue[id] = false;
      return;
    }
    const diffMin = Math.floor((now - ts) / 60000);
    const isOverdue = diffMin >= minutes;
    // –ø–µ—Ä–µ—Ö–æ–¥ –≤ overdue
    if (isOverdue && !prevOverdue[id]) {
      // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â—ë –Ω–µ —É–≤–µ–¥–æ–º–ª—è–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ timestamp
      if (String(notifiedMap[id]) !== String(ts)) {
        notifyOverdue(id, ts, diffMin).catch(console.warn);
        // –æ—Ç–º–µ—Ç–∏–º, —á—Ç–æ —É–≤–µ–¥–æ–º–∏–ª–∏
        notifiedMap[id] = ts;
        writeNotifiedMap(notifiedMap);
      }
    }
    // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å
    if (isOverdue) item.classList.add('overdue'); else item.classList.remove('overdue');
    prevOverdue[id] = isOverdue;
  });
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
function restoreAll() {
  const map = readLastMap();
  Object.keys(TASKS).forEach(id => setLastText(id, map[id]));
  // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å prevOverdue –±–µ–∑ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—á—Ç–æ–±—ã —Å—Ä–∞–∑—É –Ω–µ —Å–ª–∏—Ç—å –∫—É—á—É –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π)
  const now = Date.now();
  Object.entries(TASKS).forEach(([id, minutes]) => {
    const ts = map[id];
    const diffMin = ts ? Math.floor((now - ts) / 60000) : 0;
    prevOverdue[id] = ts ? (diffMin >= minutes) : false;
  });
  // –ø–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏–µ –∏ –Ω–∞—á–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  refreshOverdue();
}
restoreAll();
setInterval(refreshOverdue, 60_000);

// notifyOverdue: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ SW –µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise
async function notifyOverdue(id, ts, diffMin) {
  if (!('Notification' in window)) return;
  if (Notification.permission !== 'granted') return;

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–ª–æ
  const titleEl = document.querySelector(`#${id} .title`);
  const title = titleEl ? titleEl.textContent : '–í–Ω–∏–º–∞–Ω–∏–µ';
  const elapsedText = formatElapsed(Date.now() - ts);
  const body = `${title} ‚Äî –ø—Ä–æ—à–ª–æ ${elapsedText}.`;

  // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å —á–µ—Ä–µ–∑ service worker (–µ—Å–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
  const reg = await ensureSWRegistration();
  if (reg && reg.showNotification) {
    try {
      await reg.showNotification(title, { body, icon: 'favicon.png', data: { id, ts } });
      return;
    } catch (e) {
      console.warn('reg.showNotification failed:', e);
    }
  }
  // fallback: —á–µ—Ä–µ–∑ Notification API (–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Ñ–æ–Ω–µ/–≤ —Ñ–æ–∫—É—Å–µ)
  try {
    new Notification(title, { body, icon: 'favicon.png', data: { id, ts } });
  } catch (e) {
    console.warn('Notification fallback failed:', e);
  }
}

// ====== –§—É–Ω–∫—Ü–∏—è markDone: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç timestamp, –æ—á–∏—â–∞–µ—Ç —Ñ–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ======
function markDone(id, minutes) {
  const map = readLastMap();
  const ts = Date.now();
  map[id] = ts;
  writeLastMap(map);
  setLastText(id, ts);

  // —É–±—Ä–∞—Ç—å –ø–æ–º–µ—Ç–∫—É notified ‚Äî —á—Ç–æ–±—ã –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–Ω–æ–≤–∞ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
  const notifiedMap = readNotifiedMap();
  if (notifiedMap[id]) { delete notifiedMap[id]; writeNotifiedMap(notifiedMap); }

  const item = document.getElementById(id);
  if (item) {
    item.classList.remove('overdue');
    item.classList.add('done');
    setTimeout(() => item.classList.remove('done'), 2000);
  }
}
window.markDone = markDone;

// ====== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∞–µ—Ç toggle ======
async function saveTokenToDatabase(token) {
  try {
    await set(ref(db, 'fcmTokens/' + token), { createdAt: Date.now() });
  } catch (e) {
    console.warn('Failed to save token: ', e);
  }
}

async function registerSwAndGetToken() {
  if (!('serviceWorker' in navigator)) {
    errorMessage.textContent = 'Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.';
    return;
  }
  try {
    const registration = await ensureSWRegistration();
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      errorMessage.textContent = '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.';
      return;
    }
    const options = { serviceWorkerRegistration: registration, vapidKey: VAPID_KEY };
    const currentToken = await getToken(messaging, options);
    if (currentToken) {
      await saveTokenToDatabase(currentToken);
      document.getElementById('notificationsToggle').checked = true;
    } else {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω.');
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', err);
    errorMessage.textContent = '–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ' + (err?.message || err);
  }
}

onMessage(messaging, (payload) => {
  if (payload?.notification?.title) {
    alert(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${payload.notification.title}\n${payload.notification.body || ''}`);
  }
});

const notificationsToggle = document.getElementById('notificationsToggle');
notificationsToggle.addEventListener('change', async (e) => {
  if (e.target.checked) await registerSwAndGetToken();
  else errorMessage.textContent = ''; // –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ
});

// –ï—Å–ª–∏ —Ä–∞–Ω–µ–µ —É–∂–µ –¥–∞–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ‚Äî –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º SW (—á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç overdue –º–æ–≥–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è)
if (Notification.permission === 'granted') {
  ensureSWRegistration().catch(()=>{});
}
</script>
</body>
</html>
