<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MidwifeApp</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
:root {
    --bg-color: #f9f9f9;
    --text-color: #333;
    --item-bg: #fff;
    --item-border: #ddd;
    --item-overdue-bg: #ffecec;
    --item-overdue-border: #ff0000;
    --item-done-bg: #e6f4ea;
    --item-done-border: #28a745;
    --button-bg: #007bff;
    --button-hover-bg: #0056b3;
}
body.dark {
    --bg-color: #1e1e1e;
    --text-color: #eee;
    --item-bg: #2c2c2c;
    --item-border: #444;
    --item-overdue-bg: #5a1e1e;
    --item-overdue-border: #ff6666;
    --item-done-bg: #1e452e;
    --item-done-border: #28a745;
    --button-bg: #28a745;
    --button-hover-bg: #1c6e2a;
}

body {
    font-family: Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: background-color 0.3s, color 0.3s;
}

h1 { text-align: center; color: var(--text-color); }

.item {
    background-color: var(--item-bg);
    border: 1px solid var(--item-border);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    width: 100%;
    max-width: 400px;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}

.item.overdue { border-color: var(--item-overdue-border); background-color: var(--item-overdue-bg); }
.item.done { border-color: var(--item-done-border); background-color: var(--item-done-bg); }

.icon {
    font-size: 24px;
    margin-right: 15px;
    color: var(--text-color);
}

.content { flex: 1; }

.title {
    font-size: 18px;
    font-weight: bold;
    margin: 0;
    color: var(--text-color);
}

.description, .last-time {
    font-size: 14px;
    color: var(--text-color);
    margin: 5px 0;
}

button {
    background-color: var(--button-bg);
    color: var(--text-color);
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
}

button:hover { background-color: var(--button-hover-bg); }

#error-message { color: red; text-align: center; margin-top: 10px; }

/* Toggle –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
#notifications-control, #theme-control {
    width: 100%;
    max-width: 400px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    margin-bottom: 20px;
}

#notifications-control .toggle-label, #theme-control .toggle-label {
    font-size: 14px;
    color: var(--text-color);
    user-select: none;
}

.toggle {
    position: relative;
    width: 44px;
    height: 24px;
}

.toggle input { display: none; }

.toggle .slider {
    position: absolute;
    inset: 0;
    background: #ccc;
    border-radius: 24px;
    transition: .2s;
}

.toggle .slider::after {
    content: "";
    position: absolute;
    width: 18px; height: 18px;
    left: 3px; top: 3px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    transition: .2s;
}

.toggle input:checked + .slider { background: #28a745; }
.toggle input:checked + .slider::after { transform: translateX(20px); }

/* –°—Å—ã–ª–∫–∞ –Ω–∞ events.html */
#events-link {
    display: block;
    margin-bottom: 20px;
    text-decoration: none;
    color: var(--text-color);
    font-weight: bold;
}

#events-link:hover { text-decoration: underline; }

</style>
</head>
<body>

<div id="theme-control" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã">
    <span class="toggle-label">–ù–æ—á–Ω–∞—è —Ç–µ–º–∞</span>
    <label class="toggle">
        <input type="checkbox" id="themeToggle">
        <span class="slider" aria-hidden="true"></span>
    </label>
</div>

<h1>–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ—Ä–æ–∂–¥—ë–Ω–Ω–æ–≥–æ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ —á–∞—Å—Ç–æ—Ç–∞</h1>
<a id="events-link" href="events.html">–°–ø–∏—Å–æ–∫ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</a>

<div id="error-message"></div>

<div class="item" id="feeding">
    <span class="icon">üçº</span>
    <div class="content">
        <p class="title">–ö–æ—Ä–º–ª–µ–Ω–∏–µ</p>
        <p class="description">–∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞ –¥–Ω—ë–º –∏ –Ω–æ—á—å—é</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('feeding', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="diaper">
    <span class="icon">ü©≤</span>
    <div class="content">
        <p class="title">–ü–æ–¥–≥—É–∑–Ω–∏–∫</p>
        <p class="description">–∫–∞–∂–¥—ã–µ 2-4 —á–∞—Å–∞</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('diaper', 240)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="sleep">
    <span class="icon">üåô</span>
    <div class="content">
        <p class="title">–°–æ–Ω</p>
        <p class="description">–≤ —Å—Ä–µ–¥–Ω–µ–º 14-17 —á–∞—Å–æ–≤ –≤ —Å—É—Ç–∫–∏</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('sleep', 1440)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="temperature">
    <span class="icon">üå°Ô∏è</span>
    <div class="content">
        <p class="title">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</p>
        <p class="description">–∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('temperature', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="burping">
    <span class="icon">üòä</span>
    <div class="content">
        <p class="title">–û—Ç—Ä—ã–∂–∫–∞</p>
        <p class="description">–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ—Ä–º–ª–µ–Ω–∏—è</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('burping', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div class="item" id="contact">
    <span class="icon">‚úã</span>
    <div class="content">
        <p class="title">–ö–æ–Ω—Ç–∞–∫—Ç</p>
        <p class="description">–∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ</p>
        <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
    </div>
    <button onclick="markDone('contact', 1440)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
</div>

<div id="notifications-control" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
    <span class="toggle-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
    <label class="toggle">
        <input type="checkbox" id="notificationsToggle">
        <span class="slider" aria-hidden="true"></span>
    </label>
</div>

<script type="module">
// --- Firebase –∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
import { getMessaging, getToken, onMessage, isSupported, deleteToken } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-messaging.js";

const errorMessage = document.getElementById('error-message');

const app = initializeApp({
    apiKey: "AIzaSyBUUrP-CevoeDOsUZorjC6XDzZ-vd3Uauw",
    authDomain: "ds-nurce-bdc37.firebaseapp.com",
    databaseURL: "https://ds-nurce-bdc37-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ds-nurce-bdc37",
    storageBucket: "ds-nurce-bdc37.appspot.com",
    messagingSenderId: "725307523922",
    appId: "1:725307523922:web:9bb5c6ae685e479719b08b"
});

const db = getDatabase(app);
let messaging = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase Messaging
const initMessaging = async () => {
    try {
        const isMessagingSupported = await isSupported();
        if (isMessagingSupported) {
            messaging = getMessaging(app);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–µ–º –ø–ª–∞–Ω–µ
            onMessage(messaging, (payload) => {
                console.log('Message received in foreground:', payload);
                if (payload.notification) {
                    showBrowserNotification(payload.notification.title, payload.notification.body);
                }
            });
            
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error initializing messaging:', error);
        return false;
    }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showBrowserNotification(title, body) {
    if (!("Notification" in window)) {
        console.log("This browser does not support notifications");
        return;
    }
    
    if (Notification.permission === "granted") {
        new Notification(title, { body, icon: "favicon.png" });
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                new Notification(title, { body, icon: "favicon.png" });
            }
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è FCM —Ç–æ–∫–µ–Ω–∞
const getFCMToken = async () => {
    try {
        if (!messaging) return null;
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            console.log('Notification permission not granted');
            return null;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
        const currentToken = await getToken(messaging, {
            vapidKey: 'BEp5FjaMusKOcJPBREZEad0ZWHMMyYAp0dl_6yeFaiNdqfrtWFJ_0lA0S5kU8usP_IJu0SkdsTrSkOsRzPGYKY4'
        });
        
        if (currentToken) {
            console.log('FCM Token:', currentToken);
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            await set(ref(db, 'fcmTokens/' + currentToken), true);
            return currentToken;
        } else {
            console.log('No registration token available. Request permission to generate one.');
            return null;
        }
    } catch (error) {
        console.error('An error occurred while retrieving token:', error);
        return null;
    }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è FCM —Ç–æ–∫–µ–Ω–∞
const deleteFCMToken = async () => {
    try {
        if (!messaging) return;
        
        const currentToken = await getToken(messaging);
        if (currentToken) {
            await deleteToken(messaging);
            // –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            await set(ref(db, 'fcmTokens/' + currentToken), null);
            console.log('Token deleted');
        }
    } catch (error) {
        console.error('Error deleting token:', error);
    }
};

const items = [
    { id: 'feeding', max: 180 },
    { id: 'diaper', max: 240 },
    { id: 'sleep', max: 1440 },
    { id: 'temperature', max: 180 },
    { id: 'burping', max: 180 },
    { id: 'contact', max: 1440 }
];

const timestamps = {};
const notifiedState = {};

function formatTime(minutes) {
    if (minutes < 60) return `${minutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return m === 0 ? `${h} —á –Ω–∞–∑–∞–¥` : `${h} —á ${m} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ FCM
async function sendFCMPushNotification(itemId, itemName) {
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–æ–≤ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ API
        console.log(`Sending FCM push notification for ${itemId}: ${itemName}`);
        
        // –í–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É, –º—ã –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ fetch –∏–ª–∏ axios –¥–ª—è –≤—ã–∑–æ–≤–∞ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        // –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ FCM
        /*
        await fetch('https://your-server.com/send-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                itemId,
                itemName,
                message: `–ü–æ—Ä–∞ ${itemName}!`
            })
        });
        */
    } catch (error) {
        console.error('Error sending FCM push notification:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ overdue
function updateTime(id, maxMinutes, timestamp) {
    const item = document.getElementById(id);
    const lastTimeElem = item.querySelector('.last-time');
    const wasOverdue = item.classList.contains('overdue');

    if (timestamp) {
        const diff = Date.now() - timestamp;
        const minutesAgo = Math.floor(diff / 60000);
        lastTimeElem.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${formatTime(minutesAgo)}`;
        item.classList.remove('overdue', 'done');
        if (minutesAgo > maxMinutes) {
            item.classList.add('overdue');
            if (!wasOverdue && !notifiedState[id] && notificationsEnabled) {
                const itemName = item.querySelector('.title')?.textContent.trim() || id;
                // –í–º–µ—Å—Ç–æ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ —á–µ—Ä–µ–∑ FCM
                sendFCMPushNotification(id, itemName);
                notifiedState[id] = true;
            }
        } else {
            item.classList.add('done');
            notifiedState[id] = false;
        }
    } else {
        lastTimeElem.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞';
        item.classList.add('overdue');
        item.classList.remove('done');
        if (!wasOverdue && !notifiedState[id] && notificationsEnabled) {
            const itemName = item.querySelector('.title')?.textContent.trim() || id;
            // –í–º–µ—Å—Ç–æ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ —á–µ—Ä–µ–∑ FCM
            sendFCMPushNotification(id, itemName);
            notifiedState[id] = true;
        }
    }
}

window.markDone = function(id, maxMinutes) {
    const now = Date.now();
    set(ref(db, 'actions/' + id), { timestamp: now })
        .catch(err => {
            console.error(err);
            errorMessage.textContent = `–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${err.message}`;
        });
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const notificationsToggle = document.getElementById('notificationsToggle');
let notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
if (notificationsToggle) notificationsToggle.checked = notificationsEnabled;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
notificationsToggle?.addEventListener('change', async () => {
    notificationsEnabled = notificationsToggle.checked;
    localStorage.setItem('notificationsEnabled', notificationsEnabled ? 'true' : 'false');
    
    if (notificationsEnabled) {
        // –í–∫–ª—é—á–∞–µ–º FCM —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const messagingInitialized = await initMessaging();
        if (messagingInitialized) {
            await getFCMToken();
            immediateOverdueCheck();
        } else {
            console.log('FCM not supported in this environment');
            notificationsToggle.checked = false;
            notificationsEnabled = false;
            localStorage.setItem('notificationsEnabled', 'false');
        }
    } else {
        // –û—Ç–∫–ª—é—á–∞–µ–º FCM —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        await deleteFCMToken();
    }
});

function immediateOverdueCheck() {
    items.forEach(it => {
        const el = document.getElementById(it.id);
        if (!el) return;
        if (el.classList.contains('overdue') && !notifiedState[it.id] && notificationsEnabled) {
            const itemName = el.querySelector('.title')?.textContent.trim() || it.id;
            sendFCMPushNotification(it.id, itemName);
            notifiedState[it.id] = true;
        }
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
items.forEach(item => {
    const r = ref(db, 'actions/' + item.id);
    onValue(r, snap => {
        const data = snap.val();
        timestamps[item.id] = data ? data.timestamp : null;
        updateTime(item.id, item.max, timestamps[item.id]);
    }, err => {
        console.error(err);
        errorMessage.textContent = `–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${err.message}`;
    });
});

setInterval(() => {
    items.forEach(item => {
        updateTime(item.id, item.max, timestamps[item.id]);
    });
}, 60000);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FCM –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
if (notificationsEnabled) {
    initMessaging().then(messagingInitialized => {
        if (messagingInitialized) {
            getFCMToken();
            setTimeout(() => immediateOverdueCheck(), 300);
        }
    });
}

// --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã ---
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'light';
if (savedTheme === 'dark') document.body.classList.add('dark');
if (themeToggle) themeToggle.checked = savedTheme === 'dark';

themeToggle?.addEventListener('change', () => {
    if (themeToggle.checked) {
        document.body.classList.add('dark');
        localStorage.setItem('theme', 'dark');
    } else {
        document.body.classList.remove('dark');
        localStorage.setItem('theme', 'light');
    }
});
</script>

</body>
</html>
