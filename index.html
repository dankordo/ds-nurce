<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MidwifeApp</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { text-align: center; color: #333; }
        .item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            width: 100%;
            max-width: 400px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .item.overdue { border-color: #ff0000; background-color: #ffecec; }
        .item.done { border-color: #28a745; background-color: #e6f4ea; }
        .icon { font-size: 24px; margin-right: 15px; color: #666; }
        .content { flex: 1; }
        .title { font-size: 18px; font-weight: bold; margin: 0; }
        .description { font-size: 14px; color: #666; margin: 5px 0; }
        .last-time { font-size: 12px; color: #888; }
        button {
            background-color: #007bff; color: white; border: none; border-radius: 20px;
            padding: 8px 15px; font-size: 14px; cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        #error-message { color: red; text-align: center; margin-top: 10px; }

        /* --- –î–û–ë–ê–í–õ–ï–ù–û: –Ω–µ–±–æ–ª—å—à–æ–π toggle –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ --- */
        #notifications-control {
            width: 100%;
            max-width: 400px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 6px;
        }
        #notifications-control .toggle-label {
            font-size: 14px;
            color: #333;
            user-select: none;
        }
        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle input { display: none; }
        .toggle .slider {
            position: absolute;
            inset: 0;
            background: #ccc;
            border-radius: 24px;
            transition: .2s;
        }
        .toggle .slider::after {
            content: "";
            position: absolute;
            width: 18px; height: 18px;
            left: 3px; top: 3px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: .2s;
        }
        .toggle input:checked + .slider {
            background: #28a745;
        }
        .toggle input:checked + .slider::after {
            transform: translateX(20px);
        }
        /* --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–ô CSS --- */
    </style>
</head>
<body>
    <h1>–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ—Ä–æ–∂–¥—ë–Ω–Ω–æ–≥–æ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ —á–∞—Å—Ç–æ—Ç–∞</h1>
    <div id="error-message"></div>

    <div class="item" id="feeding">
        <span class="icon">üçº</span>
        <div class="content">
            <p class="title">–ö–æ—Ä–º–ª–µ–Ω–∏–µ</p>
            <p class="description">–∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞ –¥–Ω—ë–º –∏ –Ω–æ—á—å—é</p>
            <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
        </div>
        <button onclick="markDone('feeding', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
    </div>

    <div class="item" id="diaper">
        <span class="icon">ü©≤</span>
        <div class="content">
            <p class="title">–ü–æ–¥–≥—É–∑–Ω–∏–∫</p>
            <p class="description">–∫–∞–∂–¥—ã–µ 2-4 —á–∞—Å–∞</p>
            <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
        </div>
        <button onclick="markDone('diaper', 240)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
    </div>

    <div class="item" id="sleep">
        <span class="icon">üåô</span>
        <div class="content">
            <p class="title">–°–æ–Ω</p>
            <p class="description">–≤ —Å—Ä–µ–¥–Ω–µ–º 14-17 —á–∞—Å–æ–≤ –≤ —Å—É—Ç–∫–∏</p>
            <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
        </div>
        <button onclick="markDone('sleep', 1440)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
    </div>

    <div class="item" id="temperature">
        <span class="icon">üå°Ô∏è</span>
        <div class="content">
            <p class="title">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</p>
            <p class="description">–∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞</p>
            <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
        </div>
        <button onclick="markDone('temperature', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
    </div>

    <div class="item" id="burping">
        <span class="icon">üòä</span>
        <div class="content">
            <p class="title">–û—Ç—Ä—ã–∂–∫–∞</p>
            <p class="description">–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ—Ä–º–ª–µ–Ω–∏—è</p>
            <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
        </div>
        <button onclick="markDone('burping', 180)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
    </div>

    <div class="item" id="contact">
        <span class="icon">‚úã</span>
        <div class="content">
            <p class="title">–ö–æ–Ω—Ç–∞–∫—Ç</p>
            <p class="description">–∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ</p>
            <p class="last-time">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞</p>
        </div>
        <button onclick="markDone('contact', 1440)">–°–¥–µ–ª–∞–Ω–æ —Å–µ–π—á–∞—Å</button>
    </div>

    <!-- –î–û–ë–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notifications-control" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
        <span class="toggle-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        <label class="toggle">
            <input type="checkbox" id="notificationsToggle">
            <span class="slider" aria-hidden="true"></span>
        </label>
    </div>
    <!-- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–ô -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

        const errorMessage = document.getElementById('error-message');

        const app = initializeApp({
            apiKey: "AIzaSyBUUrP-CevoeDOsUZorjC6XD–∑Z-vd3Uauw",
            authDomain: "ds-nurce-bdc37.firebaseapp.com",
            databaseURL: "https://ds-nurce-bdc37-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ds-nurce-bdc37",
            storageBucket: "ds-nurce-bdc37.appspot.com",
            messagingSenderId: "725307523922",
            appId: "1:725307523922:web:9bb5c6ae685e479719b08b"
        });

        const db = getDatabase(app);

        const items = [
            { id: 'feeding', max: 180 },
            { id: 'diaper', max: 240 },
            { id: 'sleep', max: 1440 },
            { id: 'temperature', max: 180 },
            { id: 'burping', max: 180 },
            { id: 'contact', max: 1440 }
        ];

        function formatTime(minutes) {
            if (minutes < 60) return `${minutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return m === 0 ? `${h} —á –Ω–∞–∑–∞–¥` : `${h} —á ${m} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
        }

        /* --- –î–û–ë–ê–í–õ–ï–ù–û: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è --- */
        const notificationsToggle = document.getElementById('notificationsToggle');
        let notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
        const notifiedState = {}; // { [id]: boolean } ‚Äî —É–∂–µ —É–≤–µ–¥–æ–º–ª—ë–Ω –¥–ª—è —Ç–µ–∫—É—â–µ–π "–∫—Ä–∞—Å–Ω–æ–π" —Ñ–∞–∑—ã

        if (notificationsToggle) {
            notificationsToggle.checked = notificationsEnabled;
        }

        function ensureNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'default') {
                Notification.requestPermission().catch(() => {});
            }
        }

        function sendNotificationFor(id) {
            if (!notificationsEnabled || !('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;
            const item = document.getElementById(id);
            if (!item) return;
            const titleEl = item.querySelector('.title');
            const name = titleEl ? titleEl.textContent.trim() : id;
            try {
                new Notification(`–ü–æ—Ä–∞ ${name}!`);
            } catch(e) {
                // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å UX
            }
        }

        function immediateOverdueCheck() {
            // –ø—Ä–æ–π–¥—ë–º –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –∏, –µ—Å–ª–∏ —É–∂–µ –∫—Ä–∞—Å–Ω—ã–µ –∏ –Ω–µ —É–≤–µ–¥–æ–º–ª—è–ª–∏ ‚Äî —É–≤–µ–¥–æ–º–∏–º
            items.forEach(it => {
                const el = document.getElementById(it.id);
                if (!el) return;
                const isOverdue = el.classList.contains('overdue');
                if (isOverdue && !notifiedState[it.id]) {
                    sendNotificationFor(it.id);
                    notifiedState[it.id] = true;
                }
            });
        }

        notificationsToggle?.addEventListener('change', () => {
            notificationsEnabled = notificationsToggle.checked;
            localStorage.setItem('notificationsEnabled', notificationsEnabled ? 'true' : 'false');
            if (notificationsEnabled) {
                ensureNotificationPermission();
                // –°—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —É–≤–µ–¥–æ–º–∏—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å —É–∂–µ –∫—Ä–∞—Å–Ω—ã–µ
                immediateOverdueCheck();
            }
        });
        /* --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–ô —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π --- */

        function updateTime(id, maxMinutes, timestamp) {
            const item = document.getElementById(id);
            const lastTimeElem = item.querySelector('.last-time');

            // –î–û–ë–ê–í–õ–ï–ù–û: –∑–∞–ø–æ–º–Ω–∏–º –ø—Ä–µ–∂–Ω–µ–µ "–∫—Ä–∞—Å–Ω–æ–µ" —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const wasOverdue = item.classList.contains('overdue');

            if (timestamp) {
                const diff = Date.now() - timestamp;
                const minutesAgo = Math.floor(diff / 60000);
                lastTimeElem.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${formatTime(minutesAgo)}`;
                item.classList.remove('overdue', 'done');
                if (minutesAgo > maxMinutes) {
                    item.classList.add('overdue');
                    // –î–û–ë–ê–í–õ–ï–ù–û: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ "–∫—Ä–∞—Å–Ω–æ–µ"
                    if (!wasOverdue && !notifiedState[id]) {
                        sendNotificationFor(id);
                        notifiedState[id] = true;
                    }
                } else {
                    item.classList.add('done');
                    // —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞, —á—Ç–æ–±—ã –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ —Å–Ω–æ–≤–∞ —É–≤–µ–¥–æ–º–∏—Ç—å –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ
                    notifiedState[id] = false;
                }
            } else {
                lastTimeElem.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: –Ω–∏–∫–æ–≥–¥–∞';
                item.classList.add('overdue');
                item.classList.remove('done');
                // –î–û–ë–ê–í–õ–ï–ù–û: –µ—Å–ª–∏ —É–∂–µ –∫—Ä–∞—Å–Ω—ã–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ ‚Äî —É–≤–µ–¥–æ–º–∏—Ç—å (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)
                if (!wasOverdue && !notifiedState[id]) {
                    sendNotificationFor(id);
                    notifiedState[id] = true;
                }
            }
        }

        window.markDone = function (id, maxMinutes) {
            const now = Date.now();
            set(ref(db, 'actions/' + id), { timestamp: now })
                .catch(err => {
                    console.error(err);
                    errorMessage.textContent = `–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${err.message}`;
                });
        };

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        items.forEach(item => {
            const r = ref(db, 'actions/' + item.id);
            onValue(r, snap => {
                const data = snap.val();
                updateTime(item.id, item.max, data ? data.timestamp : null);
            }, err => {
                console.error(err);
                errorMessage.textContent = `–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${err.message}`;
            });
        });

        // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –º–∏–Ω—É—Ç
        setInterval(() => {
            items.forEach(item => {
                const el = document.getElementById(item.id);
                const txt = el.querySelector('.last-time').textContent;

                // –î–û–ë–ê–í–õ–ï–ù–û: –ø—Ä–µ–∂–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const wasOverdue = el.classList.contains('overdue');

                const match = txt.match(/(\d+) –º–∏–Ω/);
                if (match) {
                    let m = parseInt(match[1]) + 1;
                    el.querySelector('.last-time').textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${formatTime(m)}`;
                    el.classList.remove('overdue', 'done');
                    const max = items.find(i => i.id === el.id).max;
                    if (m > max) {
                        el.classList.add('overdue');
                        if (!wasOverdue && !notifiedState[item.id]) {
                            sendNotificationFor(item.id);
                            notifiedState[item.id] = true;
                        }
                    } else {
                        el.classList.add('done');
                        notifiedState[item.id] = false;
                    }
                } else if (txt.includes('—á')) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Å—ã
                    const timeMatch = txt.match(/(\d+) —á(?: (\d+) –º–∏–Ω)?/);
                    if (timeMatch) {
                        let hours = parseInt(timeMatch[1]);
                        let minutes = parseInt(timeMatch[2] || 0) + 1;
                        if (minutes >= 60) {
                            hours += 1;
                            minutes -= 60;
                        }
                        const totalMinutes = hours * 60 + minutes;
                        el.querySelector('.last-time').textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${formatTime(totalMinutes)}`;
                        const max = items.find(i => i.id === el.id).max;
                        el.classList.remove('overdue', 'done');
                        if (totalMinutes > max) {
                            el.classList.add('overdue');
                            if (!wasOverdue && !notifiedState[item.id]) {
                                sendNotificationFor(item.id);
                                notifiedState[item.id] = true;
                            }
                        } else {
                            el.classList.add('done');
                            notifiedState[item.id] = false;
                        }
                    }
                }
            });
        }, 60000);

        // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏: –µ—Å–ª–∏ toggle –±—ã–ª –≤–∫–ª—é—á—ë–Ω —Ä–∞–Ω–µ–µ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ "–∫—Ä–∞—Å–Ω—ã—Ö"
        if (notificationsEnabled) {
            ensureNotificationPermission();
            // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É—Å–ø–µ–ª–∏ –ø–æ–¥—Ç—è–Ω—É—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ onValue –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è –∫–ª–∞—Å—Å—ã
            setTimeout(() => immediateOverdueCheck(), 300);
        }
    </script>
</body>
    </html>
